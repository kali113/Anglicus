const k="anglicus_settings",l={apiConfig:{tier:"auto"},theme:"light",notificationsEnabled:!1},h="anglicus_encryption_key";async function b(){if(typeof window>"u"||!window.crypto)return null;try{const n=localStorage.getItem(h);if(n){const a=JSON.parse(n);return await window.crypto.subtle.importKey("jwk",a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}const e=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),t=await window.crypto.subtle.exportKey("jwk",e);return localStorage.setItem(h,JSON.stringify(t)),e}catch{return null}}async function N(n){const e=await b();if(!e)return null;try{const t=window.crypto.getRandomValues(new Uint8Array(12)),a=new TextEncoder().encode(n),r=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},e,a),o=new Uint8Array(t.length+r.byteLength);return o.set(t),o.set(new Uint8Array(r),t.length),btoa(String.fromCharCode(...o))}catch{return null}}async function x(n){const e=await b();if(!e)return null;try{const t=Uint8Array.from(atob(n),c=>c.charCodeAt(0)),a=t.slice(0,12),r=t.slice(12),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:a},e,r);return new TextDecoder().decode(o)}catch{return null}}async function j(n){const e=await N(n);if(!e)return!1;const t=i();return t.apiConfig.apiKeyEncrypted=e,E(t),!0}async function f(){const e=i().apiConfig.apiKeyEncrypted;return e?await x(e):null}function i(){if(typeof window>"u")return l;try{const n=localStorage.getItem(k);return n?{...l,...JSON.parse(n)}:l}catch{return l}}function E(n){typeof window>"u"||localStorage.setItem(k,JSON.stringify(n))}function T(n){const t={...i(),...n};E(t)}function I(n){T({apiConfig:{...i().apiConfig,tier:n}})}function P(n){T({apiConfig:{...i().apiConfig,customBaseUrl:n}})}const S="llama-3.1-8b",C="https://anglicus-api.anglicus-api.workers.dev";async function d(n){const e=await fetch(`${C}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const r=await e.json();throw new Error(r.error?.message||"Backend request failed")}const t=await e.json();return{content:t.choices[0]?.message?.content||"",usage:t.usage?{promptTokens:t.usage.prompt_tokens,completionTokens:t.usage.completion_tokens,totalTokens:t.usage.total_tokens}:void 0,provider:"backend"}}const A="https://api.openai.com";async function p(n){const e=i(),t=await f();if(!t)throw new Error("BYOK no configurado: falta la API key");const a=(e.apiConfig.customBaseUrl||A).replace(/\/$/,""),r=await fetch(`${a}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(n)});if(!r.ok){const s=await r.json();throw new Error(s.error?.message||"BYOK request failed")}const o=await r.json();return{content:o.choices[0]?.message?.content||"",usage:o.usage?{promptTokens:o.usage.prompt_tokens,completionTokens:o.usage.completion_tokens,totalTokens:o.usage.total_tokens}:void 0,provider:"byok"}}async function y(n){const e=await fetch("https://api.puterjs.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "},body:JSON.stringify({model:"gpt-3.5-turbo",messages:n,max_tokens:500})});if(!e.ok)throw new Error("Puter.js request failed");const t=await e.json();return{content:t.choices[0]?.message?.content||"",usage:t.usage?{promptTokens:t.usage.prompt_tokens,completionTokens:t.usage.completion_tokens,totalTokens:t.usage.total_tokens}:void 0,provider:"puter"}}async function $(n,e={}){const t=i(),a={model:e.model||S,messages:n,temperature:e.temperature??.7,max_tokens:e.maxTokens||500};let r=null;switch(t.apiConfig.tier){case"backend":try{return await d(a)}catch(o){r=o}break;case"byok":try{return await p(a)}catch(o){r=o}break;case"puter":try{return await y(n)}catch(o){r=o}break;default:try{return await d(a)}catch(o){r=o}try{return await p(a)}catch(o){r=o}try{return await y(n)}catch(o){r=o}break}throw new Error(`All API tiers failed. Last error: ${r?.message||"Unknown"}`)}async function L(n,e,t={}){const a=i(),r={model:t.model||"llama-3.1-8b",messages:n,temperature:t.temperature??.7,max_tokens:t.maxTokens||500,stream:!0};let o="",c={"Content-Type":"application/json"};if(a.apiConfig.tier==="byok"){const s=await f();if(!s)throw new Error("BYOK not configured");o=`${(a.apiConfig.customBaseUrl||A).replace(/\/$/,"")}/v1/chat/completions`,c.Authorization=`Bearer ${s}`}else o=`${C}/v1/chat/completions`;try{const s=await fetch(o,{method:"POST",headers:c,body:JSON.stringify(r)});if(!s.ok)throw new Error(`Stream request failed: ${s.statusText}`);if(!s.body)throw new Error("No response body");const g=s.body.getReader(),_=new TextDecoder;for(;;){const{done:v,value:K}=await g.read();if(v)break;const O=_.decode(K).split(`
`).filter(u=>u.trim()!=="");for(const u of O)if(u!=="data: [DONE]"&&u.startsWith("data: "))try{const w=JSON.parse(u.slice(6)).choices?.[0]?.delta?.content;w&&e(w)}catch(m){console.warn("Error parsing stream chunk",m)}}}catch(s){throw console.error("Stream error:",s),s}}async function D(n){if(i(),n==="byok"&&!await f())return{success:!1,error:"No API key configurada. Guarda tu API key primero."};try{const e={model:S,messages:[{role:"user",content:"Hello"}],max_tokens:10};let t;switch(n){case"backend":t=await d(e);break;case"byok":t=await p(e);break;case"puter":t=await y(e.messages);break;default:return{success:!1,error:"Tier no válido"}}return{success:t.content.length>0}}catch(e){return{success:!1,error:U(e)}}}function U(n){const e=n.message.toLowerCase();return e.includes("failed to fetch")||e.includes("networkerror")?"Error de red - verifica tu conexión":e.includes("cors")||e.includes("cross-origin")?"Error CORS - el servidor no permite esta conexión":e.includes("401")||e.includes("unauthorized")||e.includes("invalid api key")?"API key inválida o expirada":e.includes("429")||e.includes("rate limit")||e.includes("too many requests")?"Límite de peticiones excedido":e.includes("500")||e.includes("502")||e.includes("503")||e.includes("504")?"Error del servidor - intenta más tarde":e.includes("timeout")||e.includes("timed out")?"Tiempo de espera agotado":e.includes("byok no configurado")||e.includes("falta la api key")?"Falta configurar la API key":n.message.length>50?n.message.substring(0,47)+"...":n.message}export{i as a,I as b,P as c,j as d,$ as g,L as s,D as t};
